<!doctype html>
<!-- htmlhint attr-lowercase:false -->
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>Java Chat - Beautiful AI-Powered Java Learning</title>
    
    <!-- Prism.js for syntax highlighting -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
    
    <style>
        /* CSS Variables for Design System */
        :root {
            /* Color System */
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --surface-100: #f8fafc;
            --surface-200: #f1f5f9;
            --surface-300: #e2e8f0;
            --surface-400: #cbd5e1;
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --text-tertiary: #64748b;
            --accent-primary: #667eea;
            --accent-secondary: #764ba2;
            --accent-success: #10b981;
            --accent-warning: #f59e0b;
            --accent-error: #ef4444;
            --accent-info: #3b82f6;
            
            /* Dark theme colors */
            --dark-bg: #0b0d0f;
            --dark-surface-1: #111318;
            --dark-surface-2: #1a1d23;
            --dark-surface-3: #22262e;
            --dark-border: #2a2f36;
            --dark-text-primary: #f1f5f9;
            --dark-text-secondary: #cbd5e1;
            --dark-text-tertiary: #94a3b8;
            
            /* Typography Scale */
            --font-display: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            --font-mono: ui-monospace, SFMono-Regular, 'SF Mono', Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;
            --text-xs: 0.75rem;
            --text-sm: 0.875rem;
            --text-base: 1rem;
            --text-lg: 1.125rem;
            --text-xl: 1.25rem;
            --text-2xl: 1.5rem;
            --text-3xl: 1.875rem;
            
            /* Spacing (8px grid) */
            --space-1: 0.25rem;
            --space-2: 0.5rem;
            --space-3: 0.75rem;
            --space-4: 1rem;
            --space-5: 1.25rem;
            --space-6: 1.5rem;
            --space-8: 2rem;
            --space-10: 2.5rem;
            --space-12: 3rem;
            
            /* Shadows */
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 15px rgba(0,0,0,0.1);
            --shadow-xl: 0 20px 25px rgba(0,0,0,0.1);
            --shadow-2xl: 0 25px 50px rgba(0,0,0,0.25);
            --shadow-glow: 0 0 20px rgba(102, 126, 234, 0.4);
            
            /* Borders */
            --radius-sm: 4px;
            --radius-md: 6px;
            --radius-lg: 8px;
            --radius-xl: 12px;
            --radius-2xl: 16px;
            --radius-full: 9999px;
            
            /* Animations */
            --transition-fast: 150ms ease;
            --transition-base: 250ms ease;
            --transition-slow: 350ms ease;
            --animation-pulse: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
            --animation-shimmer: shimmer 2s ease-in-out infinite;
        }
        
        /* Dark theme (default) */
        body {
            font-family: var(--font-display);
            margin: 0;
            background: var(--dark-bg);
            color: var(--dark-text-primary);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        /* Animations */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes slideDown {
            from { opacity: 0; max-height: 0; }
            to { opacity: 1; max-height: 500px; }
        }
        
        @keyframes typing {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* Container */
        .container {
            max-width: 1024px;
            margin: 0 auto;
            padding: var(--space-6);
            animation: fadeIn 0.5s ease;
            box-sizing: border-box;
            width: 100%;
        }
        
        /* Header */
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: var(--space-4);
            margin-bottom: var(--space-8);
            padding-bottom: var(--space-6);
            border-bottom: 1px solid var(--dark-border);
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }
        
        .header-right {
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }
        
        .app-title {
            font-size: var(--text-xl);
            font-weight: 600;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        /* Pills and Badges */
        .pill {
            display: inline-flex;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-2) var(--space-3);
            background: var(--dark-surface-2);
            border: 1px solid var(--dark-border);
            border-radius: var(--radius-full);
            font-size: var(--text-xs);
            color: var(--dark-text-secondary);
            transition: all var(--transition-fast);
        }
        
        .pill:hover {
            background: var(--dark-surface-3);
            border-color: var(--accent-primary);
            transform: translateY(-1px);
        }
        
        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--accent-success);
            animation: var(--animation-pulse);
        }
        
        /* Chat Area */
        #chat {
            min-height: 400px;
            max-height: 600px;
            overflow-y: auto;
            overflow-x: hidden; /* Prevent horizontal overflow */
            padding: var(--space-4);
            padding-right: calc(var(--space-4) + 36px); /* Extra space for copy buttons */
            padding-bottom: 60px; /* Space for export button */
            background: var(--dark-surface-1);
            border: 1px solid var(--dark-border);
            border-radius: var(--radius-xl);
            margin-bottom: var(--space-6);
            scroll-behavior: smooth;
            position: relative;
            display: flex;
            flex-direction: column;
            gap: var(--space-3);
            align-items: stretch; /* Ensure children stretch properly */
        }
        
        /* Bubbles */
        .bubble {
            padding: var(--space-3) var(--space-4);
            margin: var(--space-2) 0;
            border-radius: var(--radius-xl);
            animation: fadeIn 0.3s ease;
            position: relative;
            overflow: visible;
            word-wrap: break-word;
            line-height: 1.6;
        }
        
        /* Copy button for messages - positioned outside bubble */
        .message-copy-btn {
            position: absolute;
            top: var(--space-3);
            right: -32px; /* Position outside the bubble */
            width: 28px;
            height: 28px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(30, 30, 40, 0.8);
            -webkit-backdrop-filter: blur(4px);
            backdrop-filter: blur(4px);
            border: 1px solid var(--dark-border);
            border-radius: var(--radius-md);
            color: var(--dark-text-secondary);
            cursor: pointer;
            opacity: 0;
            transition: all var(--transition-fast);
            z-index: 10;
        }
        
        .bubble:hover .message-copy-btn {
            opacity: 1;
        }
        
        .message-copy-btn:hover {
            background: var(--accent-primary);
            color: white;
            transform: scale(1.1);
        }
        
        .message-copy-btn.copied {
            background: var(--accent-success);
            color: white;
        }
        
        .bubble.user {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            margin-left: auto;
            max-width: min(500px, 60%);
            align-self: flex-end;
            box-shadow: var(--shadow-lg);
        }
        
        .bubble.assistant {
            background: var(--dark-surface-2);
            border: 1px solid var(--dark-border);
            max-width: min(700px, 75%);
            position: relative;
            align-self: flex-start;
        }
        
        
        /* Streaming text with cursor */
        .streaming-text {
            display: inline;
        }
        
        .typing-cursor {
            display: inline-block;
            width: 3px;
            height: 1.2em;
            background: var(--accent-primary);
            animation: typing 1s infinite;
            margin-left: 2px;
            vertical-align: text-bottom;
        }
        
        /* Loading skeleton */
        .skeleton {
            background: linear-gradient(
                90deg,
                var(--dark-surface-2) 25%,
                var(--dark-surface-3) 50%,
                var(--dark-surface-2) 75%
            );
            background-size: 200% 100%;
            animation: var(--animation-shimmer);
            border-radius: var(--radius-md);
            height: 20px;
            margin: var(--space-2) 0;
        }
        
        /* Citations */
        .citations-row {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-2);
            margin: var(--space-3) 0;
            padding: var(--space-3);
            background: var(--dark-surface-2);
            border-radius: var(--radius-lg);
            border: 1px solid var(--dark-border);
            animation: fadeIn 0.5s ease 0.2s;
            transform: none; /* Ensure no residual horizontal shift */
            box-sizing: border-box;
            max-width: 100%;
            width: 100%;
            position: relative;
            z-index: 1; /* content layer, below controls like copy button */
            align-self: flex-start;
        }
        
        /* Inline citation styling */
        sup.inline-citation {
            color: var(--accent-primary);
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            transition: all var(--transition-fast);
            font-size: 0.75em;
            margin: 0 1px;
            vertical-align: super;
            line-height: 0;
        }
        
        sup.inline-citation:hover {
            color: var(--accent-info);
            text-decoration: underline;
        }
        
.citation-pill {
            display: inline-flex;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-1) var(--space-3);
            background: var(--dark-surface-3);
            border: 1px solid var(--dark-border);
            border-radius: var(--radius-full);
            font-size: var(--text-xs);
            transition: all var(--transition-base);
            cursor: pointer;
            text-decoration: none;
            color: var(--dark-text-secondary);
            position: relative;
            overflow: hidden;
            white-space: nowrap;
            min-width: 0;            /* allow shrinking below content width */
            max-width: 100%;        /* never exceed row width */
        }
        
        /* Ensure the label shrinks and ellipsizes */
        .citation-pill .citation-label {
            flex: 1 1 auto;
            min-width: 0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        /* Number and icon should not shrink */
        .citation-pill .citation-number,
        .citation-pill .citation-icon {
            flex: 0 0 auto;
        }
        
        .citation-pill::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(102, 126, 234, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.3s, height 0.3s;
        }
        
        .citation-pill:hover {
            background: var(--dark-surface-3);
            border-color: var(--accent-primary);
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }
        
        .citation-pill:hover::before {
            width: 100%;
            height: 100%;
        }
        
        .citation-icon {
            width: 16px;
            height: 16px;
            opacity: 0.7;
        }
        
        .citation-number {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 18px;
            height: 18px;
            padding: 0 4px;
            background: var(--accent-primary);
            color: white;
            border-radius: var(--radius-full);
            font-size: 10px;
            font-weight: 600;
        }
        
        /* Knowledge Cards */
        .knowledge-card {
            background: var(--dark-surface-2);
            border: 1px solid var(--dark-border);
            border-radius: var(--radius-xl);
            margin: var(--space-4) 0;
            overflow: hidden;
            transition: all var(--transition-base);
            animation: fadeIn 0.5s ease 0.3s both;
        }
        
        .knowledge-card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--space-3) var(--space-4);
            background: var(--dark-surface-3);
            cursor: pointer;
            -webkit-user-select: none;
            user-select: none;
        }
        
        .knowledge-card-title {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            font-weight: 500;
            color: var(--dark-text-primary);
        }
        
        .knowledge-card-icon {
            width: 20px;
            height: 20px;
        }
        
        .knowledge-card-content {
            padding: var(--space-4);
            display: none;
        }
        
        .knowledge-card.expanded .knowledge-card-content {
            display: block;
            animation: slideDown 0.3s ease;
        }
        
        .knowledge-card.type-insight {
            border-left: 3px solid var(--accent-warning);
        }
        
        .knowledge-card.type-background {
            border-left: 3px solid var(--accent-info);
        }
        
        .knowledge-card.type-tip {
            border-left: 3px solid var(--accent-success);
        }
        
        /* Copy button for knowledge cards */
        .knowledge-card:hover .message-copy-btn {
            opacity: 1;
            visibility: visible;
        }
        
        /* Inline Enrichments - Beautiful integrated knowledge */
        .inline-enrichment {
            display: block;
            padding: var(--space-3);
            border-radius: var(--radius-lg);
            margin: var(--space-3) 0;
            transition: all var(--transition-fast);
            position: relative;
            font-size: var(--text-sm);
            line-height: 1.5;
            clear: both; /* Prevent floating issues */
        }
        
        .inline-enrichment-header {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            margin-bottom: var(--space-2);
            font-weight: 600;
            text-transform: uppercase;
            font-size: 11px;
            letter-spacing: 0.5px;
            opacity: 0.9;
        }
        
        .inline-enrichment-header svg {
            flex-shrink: 0;
            width: 16px;
            height: 16px;
        }
        
        .inline-enrichment.hint {
            background: rgba(102, 126, 234, 0.15);
            color: var(--dark-text-primary);
            border-left: 3px solid var(--accent-primary);
        }
        
        .inline-enrichment.hint .inline-enrichment-header {
            color: var(--accent-primary);
        }
        
        .inline-enrichment.reminder {
            background: rgba(250, 204, 21, 0.15);
            color: var(--dark-text-primary);
            border-left: 3px solid var(--accent-warning);
        }
        
        .inline-enrichment.reminder .inline-enrichment-header {
            color: var(--accent-warning);
        }
        
        .inline-enrichment.background {
            background: rgba(74, 222, 128, 0.15);
            color: var(--dark-text-primary);
            border-left: 3px solid var(--accent-success);
        }
        
        .inline-enrichment.background .inline-enrichment-header {
            color: var(--accent-success);
        }
        
        .inline-enrichment.warning {
            background: rgba(248, 113, 113, 0.15);
            color: var(--dark-text-primary);
            border-left: 3px solid var(--accent-error);
        }
        
        .inline-enrichment.warning .inline-enrichment-header {
            color: var(--accent-error);
        }
        
        /* Inline example blocks */
        .inline-example {
            margin: var(--space-3) 0;
            border: 1px solid var(--dark-border);
            border-radius: var(--radius-lg);
            overflow: hidden;
            background: var(--dark-surface-1);
        }
        
        .example-header {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-2) var(--space-3);
            background: var(--dark-surface-2);
            border-bottom: 1px solid var(--dark-border);
            font-size: var(--text-sm);
            font-weight: 500;
            color: var(--accent-primary);
        }
        
        .inline-example pre {
            margin: 0;
            border: none;
            background: transparent;
        }
        
        /* Enrichment text styling */
        .inline-enrichment .enrichment-text {
            display: block;
            color: var(--dark-text-primary);
            margin: 0;
        }
        
        /* Paragraph spacing with overlap prevention */
        .bubble p {
            margin: 0 0 var(--space-3) 0;
            line-height: 1.6;
        }
        
        .bubble p:last-child {
            margin-bottom: 0;
        }
        
        .bubble p:empty {
            display: none;
        }
        
        /* Adjacent sibling margin collapse for block elements only */
        .bubble > div + div,
        .bubble > p + p,
        .bubble > div + p,
        .bubble > p + div,
        .bubble > pre + p,
        .bubble > p + pre {
            margin-top: var(--space-3);
        }
        
        /* Enrichment blocks should have consistent spacing */
        .bubble .inline-enrichment {
            margin: var(--space-3) 0;
        }
        
        .bubble .inline-enrichment:first-child {
            margin-top: 0;
        }
        
        .bubble .inline-enrichment:last-child {
            margin-bottom: 0;
        }
        
        @keyframes fadeInCenter {
            from { opacity: 0; transform: translateX(-50%) translateY(4px); }
            to { opacity: 1; transform: translateX(-50%) translateY(0); }
        }
        
        /* Enhanced Tooltips */
        .tooltip {
            position: relative;
            display: inline-block;
            border-bottom: 1px dotted var(--accent-primary);
            cursor: help;
            color: var(--accent-primary);
        }
        
        .tooltip-content {
            visibility: hidden;
            opacity: 0;
            position: absolute;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--dark-surface-3);
            border: 1px solid var(--dark-border);
            border-radius: var(--radius-lg);
            padding: var(--space-3);
            width: 280px;
            max-width: 90vw;
            box-shadow: var(--shadow-2xl);
            z-index: 1000;
            transition: all var(--transition-base);
            font-size: var(--text-sm);
            line-height: 1.5;
        }
        
        .tooltip:hover .tooltip-content {
            visibility: visible;
            opacity: 1;
            transform: translateX(-50%) translateY(-5px);
        }
        
        .tooltip-content::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: var(--dark-surface-3);
        }
        
        /* Input Area - Fixed overflow */
        .input-area {
            background: var(--dark-surface-1);
            border: 1px solid var(--dark-border);
            border-radius: var(--radius-xl);
            padding: var(--space-4);
            margin-top: var(--space-4);
            width: 100%;
            box-sizing: border-box;
            overflow: hidden;
        }
        
        .input-row {
            display: flex;
            gap: var(--space-3);
            align-items: center;
            width: 100%;
            box-sizing: border-box;
        }
        
        .input-wrapper {
            flex: 1;
            position: relative;
            min-width: 0; /* Critical: allows flex item to shrink below content width */
            box-sizing: border-box;
        }
        
        .input {
            width: 100%;
            padding: var(--space-3) 50px var(--space-3) var(--space-4);
            background: var(--dark-surface-2);
            border: 2px solid var(--dark-border);
            border-radius: var(--radius-lg);
            color: var(--dark-text-primary);
            font-size: var(--text-base);
            font-family: var(--font-display);
            transition: all var(--transition-base);
            outline: none;
            box-sizing: border-box; /* Critical for proper width calculation */
        }
        
        /* Send button positioned inside input */
        #askBtn {
            position: absolute;
            right: 6px;
            top: 50%;
            transform: translateY(-50%);
            width: 36px;
            height: 36px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius-md);
        }
        
        .input:focus {
            border-color: var(--accent-primary);
            background: var(--dark-surface-3);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .input::placeholder {
            color: var(--dark-text-tertiary);
        }
        
        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-3) var(--space-4);
            background: var(--primary-gradient);
            color: white;
            border: none;
            border-radius: var(--radius-lg);
            font-size: var(--text-base);
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition-base);
            position: relative;
            overflow: hidden;
        }
        
        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.3s, height 0.3s;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }
        
        .btn:hover::before {
            width: 100%;
            height: 100%;
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn.btn-secondary {
            background: var(--dark-surface-3);
            color: var(--dark-text-primary);
            border: 1px solid var(--dark-border);
        }
        
        .btn.btn-secondary:hover {
            background: var(--dark-surface-2);
            border-color: var(--accent-primary);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Code blocks */
        pre {
            background: var(--dark-surface-1) !important;
            border: 1px solid var(--dark-border);
            border-radius: var(--radius-lg);
            padding: var(--space-4);
            overflow-x: auto;
            margin: var(--space-3) 0;
        }
        
        code {
            font-family: var(--font-mono);
            font-size: var(--text-sm);
        }
        
        /* Inline code */
        .bubble code:not([class*="language-"]) {
            background: var(--dark-surface-3);
            padding: 2px 6px;
            border-radius: var(--radius-sm);
            color: var(--accent-primary);
        }
        
        /* Copy button for code blocks */
        .code-block-wrapper {
            position: relative;
        }
        
        .copy-code-btn {
            position: absolute;
            top: var(--space-2);
            right: var(--space-2);
            padding: var(--space-1) var(--space-2);
            background: var(--dark-surface-3);
            border: 1px solid var(--dark-border);
            border-radius: var(--radius-md);
            color: var(--dark-text-secondary);
            font-size: var(--text-xs);
            cursor: pointer;
            transition: all var(--transition-fast);
        }
        
        .copy-code-btn:hover {
            background: var(--dark-surface-2);
            color: var(--dark-text-primary);
        }
        
        /* Export chat button */
        .export-chat-btn {
            position: absolute;
            bottom: var(--space-3);
            left: 50%;
            transform: translateX(-50%);
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--dark-surface-3);
            border: 1px solid var(--dark-border);
            color: var(--dark-text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-base);
            box-shadow: var(--shadow-md);
            z-index: 50;
        }
        
        .export-chat-btn:hover {
            background: var(--accent-primary);
            color: white;
            transform: translateX(-50%) translateY(-2px);
            box-shadow: var(--shadow-lg);
        }
        
        .export-chat-btn::after {
            content: 'Copy entire chat';
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            margin-bottom: 8px;
            padding: 6px 12px;
            background: var(--dark-surface-3);
            border: 1px solid var(--dark-border);
            border-radius: var(--radius-md);
            font-size: var(--text-xs);
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all var(--transition-fast);
            pointer-events: none;
        }
        
        .export-chat-btn:hover::after {
            opacity: 1;
            visibility: visible;
        }
        
        /* Theme toggle */
        .theme-toggle {
            position: fixed;
            bottom: var(--space-6);
            right: var(--space-6);
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--primary-gradient);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow-xl);
            transition: all var(--transition-base);
            z-index: 100;
        }
        
        .theme-toggle:hover {
            transform: scale(1.1);
            box-shadow: var(--shadow-2xl);
        }
        
        /* Accessibility */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }
        
        /* Focus styles */
        *:focus-visible {
            outline: 2px solid var(--accent-primary);
            outline-offset: 2px;
        }
        
        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--dark-surface-1);
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--dark-surface-3);
            border-radius: var(--radius-full);
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--dark-border);
        }
        
        /* Responsive design */
        @media (max-width: 768px) {
            .container {
                padding: var(--space-4);
            }
            
            .header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .bubble.user {
                max-width: 100%;
            }
            
            .input-row {
                flex-direction: column;
            }
            
            .input-wrapper {
                width: 100%;
            }
            
            #chat {
                max-height: 400px;
            }
        }
        
        /* Small-screen safeguards to avoid control/content overlap */
        @media (max-width: 600px) {
            /* Reserve room for the 36px copy button on the right */
            .bubble { padding-right: calc(var(--space-4) + 36px); }
            /* Bring the copy button inside the bubble */
            .message-copy-btn { right: var(--space-2); }
            /* Ensure citations have breathing room below content */
            .bubble.assistant .citations-row { margin-top: var(--space-3); }
        }
        
        /* Loading dots animation */
        .loading-dots {
            display: inline-flex;
            gap: 4px;
        }
        
        .loading-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--accent-primary);
            animation: bounce 1.4s infinite ease-in-out both;
        }
        
        .loading-dot:nth-child(1) {
            animation-delay: -0.32s;
        }
        
        .loading-dot:nth-child(2) {
            animation-delay: -0.16s;
        }
        
        @keyframes bounce {
            0%, 80%, 100% {
                transform: scale(0);
                opacity: 0.5;
            }
            40% {
                transform: scale(1);
                opacity: 1;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-left">
                <h1 class="app-title">Java Chat</h1>
                <span class="pill">
                    <span class="status-indicator"></span>
                    JDK 24 Docs
                </span>
                <span class="pill">AI-Powered Learning</span>
            </div>
            <div class="header-right">
                <!-- Buttons removed - copy buttons are now on each message, export is at bottom -->
            </div>
        </div>
        
        <div id="chat" role="log" aria-live="polite" aria-label="Chat messages">
            <!-- Chat messages will appear here -->
        </div>
        
        <!-- Export chat button at bottom -->
        <button class="export-chat-btn" onclick="copyChat()" aria-label="Export entire chat" title="Export entire chat">
            <svg width="20" height="20" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 2L12 14"></path>
                <polyline points="19 9 12 16 5 9"></polyline>
                <path d="M5 20h14"></path>
            </svg>
        </button>
        
        <div class="input-area">
            <div class="input-row">
                <div class="input-wrapper">
                    <input 
                        id="q" 
                        class="input" 
                        placeholder="Ask about Java - try 'What are records?' or 'Explain pattern matching'"
                        aria-label="Enter your Java question"
                        autocomplete="off"
                        onkeypress="if(event.key==='Enter') ask()"
                    />
                    <button class="btn" onclick="ask()" id="askBtn" aria-label="Send question">
                        <svg width="20" height="20" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="22" y1="2" x2="11" y2="13"></line>
                            <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Theme Toggle Button -->
    <button class="theme-toggle" onclick="toggleTheme()" aria-label="Toggle theme">
        <svg width="24" height="24" viewbox="0 0 24 24" fill="white" id="themeIcon">
            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
        </svg>
    </button>
    
    <!-- Prism.js for syntax highlighting -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-java.min.js"></script>
    
    <script>
        // Enhanced streaming with character-by-character animation
        class StreamingText {
            constructor(element, text, speed = 30) {
                this.element = element;
                this.text = text;
                this.speed = speed;
                this.index = 0;
            }
            
            async stream() {
                const cursor = document.createElement('span');
                cursor.className = 'typing-cursor';
                this.element.appendChild(cursor);
                
                for (let i = 0; i < this.text.length; i++) {
                    const char = this.text[i];
                    const textNode = document.createTextNode(char);
                    this.element.insertBefore(textNode, cursor);
                    await this.delay(1000 / this.speed);
                }
                
                cursor.remove();
            }
            
            delay(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }
        }
        
        // Main chat function with enhanced UI
        async function ask() {
            const input = document.getElementById('q');
            const q = input.value.trim();
            if (!q) return;
            
            const chatEl = document.getElementById('chat');
            const askBtn = document.getElementById('askBtn');
            
            // Create user bubble with copy button
            const userBubble = document.createElement('div');
            userBubble.className = 'bubble user';
            userBubble.textContent = q;
            
            // Add copy button to user message
            const userCopyBtn = document.createElement('button');
            userCopyBtn.className = 'message-copy-btn';
            userCopyBtn.innerHTML = `<svg width="16" height="16" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
            </svg>`;
            userCopyBtn.onclick = () => copyMessage(q, userCopyBtn);
            userBubble.appendChild(userCopyBtn);
            
            chatEl.appendChild(userBubble);
            
            // Clear input and disable button
            input.value = '';
            askBtn.disabled = true;
            
            // Create assistant bubble with loading indicator
            const assistantBubble = document.createElement('div');
            assistantBubble.className = 'bubble assistant';
            
            // Add loading animation
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'loading-dots';
            loadingDiv.innerHTML = `
                <span class="loading-dot"></span>
                <span class="loading-dot"></span>
                <span class="loading-dot"></span>
            `;
            assistantBubble.appendChild(loadingDiv);
            chatEl.appendChild(assistantBubble);
            
            // Scroll to bottom
            chatEl.scrollTop = chatEl.scrollHeight;
            
            try {
                // Fetch streaming response
                const response = await fetch('/api/chat/stream', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ sessionId: 'web', latest: q })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                // Remove loading animation
                loadingDiv.remove();
                
                // Create content wrapper for streaming text
                const contentWrapper = document.createElement('div');
                contentWrapper.className = 'streaming-text';
                assistantBubble.appendChild(contentWrapper);
                
                // Add typing cursor
                const cursor = document.createElement('span');
                cursor.className = 'typing-cursor';
                contentWrapper.appendChild(cursor);
                
                // Stream the response with SSE parsing
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let fullText = '';
                let buffer = '';
                
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    const chunk = decoder.decode(value, { stream: true });
                    buffer += chunk;
                    
                    // Parse SSE format (data: prefix)
                    const lines = buffer.split('\n');
                    buffer = lines[lines.length - 1]; // Keep incomplete line in buffer
                    
                    for (let i = 0; i < lines.length - 1; i++) {
                        const line = lines[i].trim();
                        if (line.startsWith('data:')) {
                            const data = line.substring(5);
                            if (data.trim()) {
                                fullText += data;
                            }
                        }
                    }
                    
                    // Update content with proper formatting
                    const formattedText = formatText(fullText);
                    contentWrapper.innerHTML = formattedText;
                    contentWrapper.appendChild(cursor);
                    
                    // Auto-scroll
                    chatEl.scrollTop = chatEl.scrollHeight;
                }
                
                // Remove cursor when done
                cursor.remove();
                
                // Add copy button to assistant message
                const assistantCopyBtn = document.createElement('button');
                assistantCopyBtn.className = 'message-copy-btn';
                assistantCopyBtn.innerHTML = `<svg width="16" height="16" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                </svg>`;
                assistantCopyBtn.onclick = () => copyMessage(fullText, assistantCopyBtn);
                assistantBubble.appendChild(assistantCopyBtn);
                
                // Apply syntax highlighting to code blocks
                Prism.highlightAllUnder(assistantBubble);
                
                // Load citations inside the assistant bubble for tighter alignment
                await loadCitations(q, assistantBubble);
                
                // Load enrichment cards (remain at chat level below messages)
                await loadEnrichment(q, chatEl);
                
            } catch (error) {
                console.error('Streaming error:', error);
                assistantBubble.innerHTML = `
                    <div style="color: var(--accent-error);">
                        ⚠️ Error: Failed to get response. Please try again.
                    </div>
                `;
            } finally {
                askBtn.disabled = false;
                input.focus();
            }
        }
        
        // Format text with markdown-like syntax and inline enrichments
        function formatText(text) {
            // Parse inline enrichment markers FIRST (before other formatting)
            // {{hint:text}} - Helpful tips and best practices
            text = text.replace(/\{\{hint:([\s\S]*?)\}\}/g, (match, content) => {
                return `<div class="inline-enrichment hint">
                    <div class="inline-enrichment-header">
                        <svg viewbox="0 0 24 24" fill="currentColor">
                            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/>
                        </svg>
                        <span>Helpful Hint</span>
                    </div>
                    <div class="enrichment-text">${escapeHtml(content.trim())}</div>
                </div>`;
            });
            
            // {{reminder:text}} - Important things to remember
            text = text.replace(/\{\{reminder:([\s\S]*?)\}\}/g, (match, content) => {
                return `<div class="inline-enrichment reminder">
                    <div class="inline-enrichment-header">
                        <svg viewbox="0 0 24 24" fill="currentColor">
                            <path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.9 2 2 2zm6-6v-5c0-3.07-1.64-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.63 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2z"/>
                        </svg>
                        <span>Important Reminder</span>
                    </div>
                    <div class="enrichment-text">${escapeHtml(content.trim())}</div>
                </div>`;
            });
            
            // {{background:text}} - Conceptual explanations
            text = text.replace(/\{\{background:([\s\S]*?)\}\}/g, (match, content) => {
                return `<div class="inline-enrichment background">
                    <div class="inline-enrichment-header">
                        <svg viewbox="0 0 24 24" fill="currentColor">
                            <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                        </svg>
                        <span>Background Context</span>
                    </div>
                    <div class="enrichment-text">${escapeHtml(content.trim())}</div>
                </div>`;
            });
            
            // {{example:code}} - Inline code examples (enhanced formatting)
            text = text.replace(/\{\{example:([\s\S]*?)\}\}/g, (match, code) => {
                return `<div class="inline-example">
                    <div class="example-header">
                        <svg width="14" height="14" viewbox="0 0 24 24" fill="currentColor">
                            <path d="M9.4 16.6L4.8 12l4.6-4.6L8 6l-6 6 6 6 1.4-1.4zm5.2 0l4.6-4.6-4.6-4.6L16 6l6 6-6 6-1.4-1.4z"/>
                        </svg>
                        <span>Example</span>
                    </div>
                    <pre><code class="language-java">${escapeHtml(code.trim())}</code></pre>
                </div>`;
            });
            
            // {{warning:text}} - Common pitfalls to avoid
            text = text.replace(/\{\{warning:([\s\S]*?)\}\}/g, (match, content) => {
                return `<div class="inline-enrichment warning">
                    <div class="inline-enrichment-header">
                        <svg viewbox="0 0 24 24" fill="currentColor">
                            <path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/>
                        </svg>
                        <span>Warning</span>
                    </div>
                    <div class="enrichment-text">${escapeHtml(content.trim())}</div>
                </div>`;
            });
            
            // Parse inline citations [n] format FIRST
            text = text.replace(/\[(\d+)\]/g, (match, num) => {
                return `<sup class="inline-citation" data-cite="${num}">[${num}]</sup>`;
            });
            
            // Convert markdown-style code blocks
            text = text.replace(/```(\w+)?\n([\s\S]*?)```/g, (match, lang, code) => {
                const language = lang || 'java';
                return `<pre><code class="language-${language}">${escapeHtml(code.trim())}</code></pre>`;
            });
            
            // Convert inline code
            text = text.replace(/`([^`]+)`/g, '<code>$1</code>');
            
            // Convert bold text
            text = text.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
            
            // Convert italic text (but not list items that start with *)
            text = text.replace(/(?<!^|\n)\*([^*\n]+)\*/g, '<em>$1</em>');
            
            // Handle paragraphs and line breaks properly
            // First, protect block elements from being wrapped
            const blocks = [];
            let blockIndex = 0;
            
            // Temporarily replace block elements with placeholders
            text = text.replace(/(<div[^>]*>[\s\S]*?<\/div>|<pre[^>]*>[\s\S]*?<\/pre>)/g, (match) => {
                blocks.push(match);
                return `__BLOCK_${blockIndex++}__`;
            });
            
            // Now handle paragraphs for remaining text
            const paragraphs = text.split(/\n\n+/);
            text = paragraphs.map(p => {
                p = p.trim();
                if (!p) return '';
                if (p.startsWith('__BLOCK_')) return p; // Don't wrap placeholders
                // Convert single newlines to <br> within paragraphs
                return `<p>${p.replace(/\n/g, '<br>')}</p>`;
            }).filter(p => p).join('');
            
            // Restore block elements
            blocks.forEach((block, i) => {
                text = text.replace(`__BLOCK_${i}__`, block);
            });
            
            return text;
        }
        
        // Escape HTML for security
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Load and display citations
        async function loadCitations(query, container) {
            try {
                const response = await fetch('/api/chat/citations?q=' + encodeURIComponent(query));
                if (!response.ok) return;
                
                const citations = await response.json();
                if (!citations || citations.length === 0) return;
                
                const citationsRow = document.createElement('div');
                citationsRow.className = 'citations-row';
                
                citations.slice(0, 5).forEach((citation, index) => {
                    const pill = document.createElement('a');
                    pill.className = 'citation-pill';
                    pill.href = citation.url;
                    pill.target = '_blank';
                    pill.rel = 'noopener noreferrer';
                    pill.innerHTML = `
                        <span class="citation-number">${index + 1}</span>
                        <span class="citation-label">${citation.title || new URL(citation.url).hostname}</span>
                        <svg class="citation-icon" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                            <polyline points="15 3 21 3 21 9"></polyline>
                            <line x1="10" y1="14" x2="21" y2="3"></line>
                        </svg>
                    `;
                    citationsRow.appendChild(pill);
                });
                
                const exportBtn = container.querySelector('.export-chat-btn');
                if (exportBtn) {
                    container.insertBefore(citationsRow, exportBtn);
                } else {
                    container.appendChild(citationsRow);
                }
            } catch (error) {
                console.error('Error loading citations:', error);
            }
        }
        
        // Load and display enrichment cards
        async function loadEnrichment(query, container) {
            try {
                const response = await fetch('/api/enrich?q=' + encodeURIComponent(query));
                if (!response.ok) return;
                
                const enrichment = await response.json();
                
                // Create knowledge cards for different types of enrichment
                if (enrichment.hints && enrichment.hints.length > 0) {
                    const card = createKnowledgeCard('tip', '💡 Helpful Hints', enrichment.hints);
                    container.appendChild(card);
                }
                
                if (enrichment.background && enrichment.background.length > 0) {
                    const card = createKnowledgeCard('background', '📚 Background Context', enrichment.background);
                    container.appendChild(card);
                }
                
                if (enrichment.reminders && enrichment.reminders.length > 0) {
                    const card = createKnowledgeCard('insight', '🔔 Important Reminders', enrichment.reminders);
                    container.appendChild(card);
                }
            } catch (error) {
                console.error('Error loading enrichment:', error);
            }
        }
        
        // Create expandable knowledge card with copy button
        function createKnowledgeCard(type, title, items) {
            const card = document.createElement('div');
            card.className = `knowledge-card type-${type}`;
            card.style.position = 'relative';
            
            const header = document.createElement('div');
            header.className = 'knowledge-card-header';
            header.onclick = () => card.classList.toggle('expanded');
            
            const titleEl = document.createElement('div');
            titleEl.className = 'knowledge-card-title';
            titleEl.innerHTML = `
                <span>${title}</span>
                <svg width="20" height="20" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="6 9 12 15 18 9"></polyline>
                </svg>
            `;
            header.appendChild(titleEl);
            
            const content = document.createElement('div');
            content.className = 'knowledge-card-content';
            content.innerHTML = '<ul>' + items.map(item => `<li>${item}</li>`).join('') + '</ul>';
            
            // Add copy button for knowledge card
            const copyBtn = document.createElement('button');
            copyBtn.className = 'message-copy-btn';
            copyBtn.style.top = 'var(--space-2)';
            copyBtn.innerHTML = `<svg width="16" height="16" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
            </svg>`;
            const cardText = `${title}\n${items.join('\n')}`;
            copyBtn.onclick = (e) => {
                e.stopPropagation();
                copyMessage(cardText, copyBtn);
            };
            
            card.appendChild(header);
            card.appendChild(content);
            card.appendChild(copyBtn);
            
            return card;
        }
        
        // Copy functions with visual feedback
        // Copy individual message
        function copyMessage(text, button) {
            navigator.clipboard.writeText(text).then(() => {
                button.classList.add('copied');
                const originalHTML = button.innerHTML;
                button.innerHTML = `<svg width="16" height="16" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="20 6 9 17 4 12"></polyline>
                </svg>`;
                setTimeout(() => {
                    button.classList.remove('copied');
                    button.innerHTML = originalHTML;
                }, 2000);
            }).catch(() => {
                showToast('Failed to copy', 'error');
            });
        }
        
        async function copyChat() {
            try {
                const res = await fetch('/api/chat/export/session?sessionId=web');
                const txt = await res.text();
                await navigator.clipboard.writeText(txt);
                // Show success feedback on the export button
                const btn = document.querySelector('.export-chat-btn');
                if (btn) {
                    btn.style.background = 'var(--accent-success)';
                    btn.style.color = 'white';
                    setTimeout(() => {
                        btn.style.background = '';
                        btn.style.color = '';
                    }, 2000);
                }
                showToast('Chat session exported to clipboard!');
            } catch (error) {
                showToast('Failed to export', 'error');
            }
        }
        
        // Show toast notification
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                bottom: 20px;
                left: 50%;
                transform: translateX(-50%);
                padding: 12px 24px;
                background: ${type === 'error' ? 'var(--accent-error)' : 'var(--accent-success)'};
                color: white;
                border-radius: var(--radius-lg);
                box-shadow: var(--shadow-xl);
                z-index: 1000;
                animation: fadeIn 0.3s ease;
            `;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'fadeIn 0.3s ease reverse';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
        
        // Theme toggle (for future light theme)
        function toggleTheme() {
            // Placeholder for theme toggle functionality
            showToast('Light theme coming soon!', 'info');
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            const input = document.getElementById('q');
            input.focus();
            
            // Add keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                // Cmd/Ctrl + K to focus input
                if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
                    e.preventDefault();
                    input.focus();
                    input.select();
                }
                
                // Escape to clear input
                if (e.key === 'Escape' && document.activeElement === input) {
                    input.value = '';
                }
            });
        });
    </script>
</body>
</html>